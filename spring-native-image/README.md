# Spring Boot Native Image Microservice example

## Overview

This example shows you how to build, package and run a simple Spring Boot microservice as a JAR with GraalVM JDK, and as a native executable with GraalVM Native Image. The benefits of using a native executable are much smaller size, faster start-up times and reduced memory consumption.

We will make use of [GraalVM](https://www.graalvm.org), the [Spring Native](https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/) project and the [GraalVM Native Build Tools](https://github.com/graalvm/native-build-tools).

Our microservice generates a random nonsense verse in the style of the poem Jabberwocky (by Lewis Carrol). To achieve this remarkable feat, we use a Markov chain to model the text of the original poem and this model then generates random text that appears like the original.

You will learn how to build, package and run a simple Spring Boot microservice using:

- [GraalVM Enterprise in OCI Code Editor](./README-Code-Editor.md)
- [GraalVM Enterprise in OCI Cloud Shell](./README-Cloud-Shell.md)
- On other machines with Linux or macOS or Windows, follow the instuctions given below.

## Other machines with Linux or macOS or Windows

### Note on building Docker images with native executables inside on MAC

If you are using macOS or Windows in order to build a Docker image containing your native executable you will need
to build the native executable within a Docker container. How to do this is discussed later. 

### Build and run as a JAR

This project is built using Maven. To build the application so that it can be run on-top of a JVM:

```shell
mvn clean package
```

As well as building the application packaged as a`jar`, this will also build a Docker image containing the `jar` that
uses GraalVM Enterprise Edition as the JVM.

And to run from the command line:

```shell
java -jar ./target/benchmark-jibber-0.0.1-SNAPSHOT.jar &
# Add a short sleep to allow the JVM to startup
sleep 4
# Call the endpoint
curl http://localhost:8080/jibber
# Bring the app back to the foreground - you can kill it now
fg
```

To run as a Docker container, the Docker image has been generated by running Maven:

```shell
docker run --rm --name graalce -d -p 8080:8080 jibber-benchmark:graalce.0.0.1-SNAPSHOT
```
You can then test the container suing `curl` exactly as you did before - remember to allow a little time for the application to 
start up.

### Build and run a native executable

We can also build a native executable of our Spring Boot microservice, using GraalVM Native Image. In order to do this
the Maven file makes use of plugins from [GraalVM Native Build Tools](https://github.com/graalvm/native-build-tools) and
[Spring Native](https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/).

When we build it will also generate a Docker image with our native application in it.

To build the native executable version of the application:

```shell
# The -Pnative profile is used to turn on building a native executable within the maven file
mvn package native:compile -Pnative 
```

This will create a binary executable `target/jibber`. You can run this and test it in the same way as we did the Java
application:

```shell
./target/benchmark-jibber &
curl http://localhost:8080/jibber
fg
```

From the log output that the executable outputs, you can see that it starts much faster than the Java version.

### Containerizing the Native Executable

If you are linux you can now easily containerise this using the following commands:

```shell
docker build -f Dockerfiles/Dockerfile.native --build-arg APP_FILE=benchmark-jibber -t jibber-benchmark:native.0.0.1-SNAPSHOT .
```

And once that is built, you can test it as follows:

```shell
docker run --rm --name native -d -p 8080:8080 jibber-benchmark:native.0.0.1-SNAPSHOT
```

### Build A Native Image Container on Something Other than Linux

If you are not using linux as your OS, you will need to do the native image build within a docker container. To do this
we have supplied a two-stage Docker build file. 

To build:

```shell
docker build -f Dockerfiles/Dockerfile -t jibber-benchmark:native.0.0.1-SNAPSHOT .
```
And once that is built, you can test it as follows:

```shell
docker run --rm --name native -d -p 8080:8080 jibber-benchmark:native.0.0.1-SNAPSHOT
```

### Metrics And Measuring the Performance of the Application

The Spring Actuator dependency has been added to the project, along with support for Prometheus. If you
want to test the performance of either the JVM version, or the native executable version of the application you can
make use of the prometheus support. It will be available on the URL, say if you are hosting it locally on port 8080:

[http://localhost:8080/actuator/prometheus](http://localhost:8080/actuator/prometheus)

And we are done!

